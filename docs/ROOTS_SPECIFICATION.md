# Roots 仕様書 v1.0

## 障害児通所支援事業所向けSaaS管理システム

**最終更新**: 2026年2月25日
**技術スタック**: Next.js 14 / Supabase / TypeScript / Tailwind CSS

---

## 目次

1. [システム概要](#1-システム概要)
2. [アカウント体系](#2-アカウント体系)
3. [3アカウントの独立性と連携](#3-3アカウントの独立性と連携)
4. [ビジネスアプリ（施設管理者向け）](#4-ビジネスアプリ施設管理者向け)
5. [キャリアアプリ（スタッフ向け）](#5-キャリアアプリスタッフ向け)
6. [保護者アプリ](#6-保護者アプリ)
7. [実務経験証明書の発行フロー](#7-実務経験証明書の発行フロー)
8. [監査書類のワンクリック出力](#8-監査書類のワンクリック出力)
9. [減算リスク検出エンジン](#9-減算リスク検出エンジン)
10. [加算・請求システム](#10-加算請求システム)
11. [データベース設計](#11-データベース設計)
12. [セキュリティ](#12-セキュリティ)
13. [現時点の制限事項・未完成機能](#13-現時点の制限事項未完成機能)

---

## 1. システム概要

Rootsは障害児通所支援事業所（児童発達支援・放課後等デイサービス等）の運営を一元管理するSaaSプラットフォーム。

### 3つのアプリケーション

| アプリ | URL | 対象ユーザー | 主な用途 |
|--------|-----|-------------|---------|
| **ビジネス** | `/business` | 施設管理者・マネージャー | 施設運営の全管理 |
| **キャリア** | `/career` | スタッフ（全職種） | 出退勤・シフト・個人キャリア管理 |
| **保護者** | `/parent` | 保護者・家族 | 利用状況確認・施設連絡 |

### 基本構成

- **マルチテナント**: 1つのシステムで複数施設を独立管理
- **ロールベースアクセス制御**: 21種類の権限で細かくアクセス制御
- **RLS（行レベルセキュリティ）**: 57テーブルにテナント分離ポリシー適用

---

## 2. アカウント体系

### 2.1 スタッフアカウント（user_type: `staff`）

| 項目 | 内容 |
|------|------|
| 登録URL | `/career/signup` |
| 認証方式 | メール + パスワード（bcryptハッシュ） |
| 識別子 | メールアドレス or ログインID |
| ロール（システム） | `admin` / `manager` / `staff` |
| ロール（施設別） | `管理者` / `マネージャー` / `一般スタッフ` |
| アカウント状態 | `pending`（認証待ち） → `active` → `suspended` |

**登録フロー:**
1. 姓名・カナ・生年月日・性別・メール・パスワード入力
2. Supabase Auth でメール認証送信
3. 認証完了後 `account_status: active` に更新
4. 施設への所属は招待リンクまたは施設コードで後から紐付け

### 2.2 保護者アカウント（user_type: `client`）

| 項目 | 内容 |
|------|------|
| 登録URL | `/parent/signup` |
| 認証方式 | メール + パスワード（bcryptハッシュ） |
| ロール | 常に `client`（固定） |
| 施設との関係 | 直接所属しない（児童の契約を通じて間接的に接続） |

**登録フロー:**
1. 姓名・カナ・電話番号・メール・パスワード入力
2. メール認証
3. 認証後、児童情報を登録
4. 施設からの招待を受けるか、自分で利用申請

### 2.3 施設アカウント（エンティティ）

施設は独立したユーザーアカウントではなく、`facilities` テーブルのレコード。

| 項目 | 内容 |
|------|------|
| 登録URL | `/facility/register` |
| 登録者 | スタッフアカウントを持つユーザー |
| 識別子 | 5桁の施設コード（自動生成） |
| 事業所番号 | 10桁（任意） |
| オーナー | `owner_user_id` で登録者と紐付け |

---

## 3. 3アカウントの独立性と連携

### 3.1 独立性

```
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  スタッフアカウント  │  │  保護者アカウント   │  │   施設（エンティティ）│
│  user_type: staff │  │  user_type: client│  │   facilities table│
│                  │  │                  │  │                  │
│ ・独自のログイン   │  │ ・独自のログイン   │  │ ・施設コードで識別  │
│ ・個人キャリア管理  │  │ ・児童情報管理     │  │ ・設定・営業時間   │
│ ・複数施設に所属可  │  │ ・施設と直接紐付   │  │ ・定員・時間枠    │
│ ・施設なしでも利用可│  │   かない          │  │                  │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

**完全に独立したログイン**: 3つのアプリは別々のログインページ（`/career/login`, `/parent/login`）を持ち、`user_type` でフィルタリングされる。スタッフが保護者ログインページからログインすることはできない（逆も同様）。

### 3.2 連携の仕組み

```
スタッフ ──[employment_records]──> 施設 <──[contracts]── 児童 <──[owner_profile_id]── 保護者
   │                                │                    │
   │  role: 管理者/マネージャー/一般    │                    │
   │  permissions: {...}             │                    │
   │  start_date / end_date          │                    │
   │                                │                    │
   └── 複数施設に所属可能 ──────────────┘                    │
                                    │                    │
                                    └── schedules ───────┘
                                    └── usage_records ───┘
                                    └── chat_messages ───┘
                                    └── contact_logs ────┘
```

#### 連携テーブル

| テーブル | 接続する関係 | 説明 |
|---------|------------|------|
| `employment_records` | スタッフ → 施設 | 雇用関係（ロール・権限・雇用形態） |
| `contracts` | 児童 → 施設 | 利用契約（契約期間・状態） |
| `children.owner_profile_id` | 児童 → 保護者 | 親子関係 |
| `schedules` | 児童 × 施設 × 日付 | 利用スケジュール |
| `chat_messages` | 保護者 ↔ 施設 | メッセージング |
| `contact_logs` | 児童 × 施設 × 日付 | 連絡帳 |

### 3.3 マルチ施設対応

**スタッフ側:**
- 1人のスタッフが複数施設に所属可能（`employment_records` を複数行保持）
- 施設ごとに異なるロール・権限を設定可能
- キャリアアプリのホーム画面に所属施設一覧を表示
- 施設を選択するとビジネスアプリ（`/business`）へ遷移

**保護者側:**
- 1人の児童が複数施設を利用可能（`contracts` を複数行保持）
- 保護者ダッシュボードで全施設の利用状況を一覧表示
- 施設ごとにチャット・連絡帳・利用記録を分離

---

## 4. ビジネスアプリ（施設管理者向け）

### 4.1 全機能一覧

サイドバーメニュー構成と各機能の概要:

#### 利用管理カテゴリ

| 機能 | メニュー名 | 状態 | 概要 |
|------|-----------|------|------|
| 利用予約 | `schedule` | 実装済 | 月間/週間カレンダーで児童の利用枠を管理。AM/PM/終日のスロット予約、送迎手配、パターン一括登録 |
| 児童管理 | `children` | 実装済 | 児童登録ウィザード、受給者情報、契約管理、保護者招待、インテーク記録 |
| 実績と連絡帳 | `daily-log` | 実装済 | 日次の利用実績記録、健康・気分・食事・活動の記録、保護者メッセージ |
| 個別支援計画 | `support-plan` | 実装済 | 計画作成（初回/更新/変更）、期限管理、保護者同意追跡、中間・最終評価 |
| 書類管理 | `documents` | 実装済 | 38種類の法定書類のステータス管理、期限アラート、アップロード・承認ワークフロー |
| サービス提供記録 | `service-records` | 実装済 | 月次の児童別サービス実績表。個別/一括Excel出力、印刷対応 |

#### スタッフカテゴリ

| 機能 | メニュー名 | 状態 | 概要 |
|------|-----------|------|------|
| スタッフマスタ | `staff-master` | 実装済 | 従業員台帳、招待・登録、資格管理、有給設定 |
| シフト管理 | `shift` | 実装済 | 月間シフトカレンダー、シフトパターン設定、出勤簿、確認ワークフロー |
| 人員配置管理 | `staffing` | 実装済 | 月間コンプライアンスカレンダー、FTE計算、常勤換算、配置基準チェック |
| 勤務体制一覧表 | `work-schedule` | 実装済 | 行政提出用の勤務体制一覧表生成、Excel出力 |
| 研修記録 | `training` | 実装済 | 内部/外部/OJT研修の記録、参加者管理、費用追跡 |
| 休暇申請管理 | `leave-approval` | 実装済 | スタッフの有給/特別休暇/病欠申請の承認・却下 |

#### 経営カテゴリ

| 機能 | メニュー名 | 状態 | 概要 |
|------|-----------|------|------|
| ダッシュボード | `dashboard` | 実装済 | KPI概要（稼働率・売上・人件費率）、利用傾向分析、リード進捗 |
| 加算体制設定 | `addition-settings` | 実装済 | 加算の有効/無効設定、適用期間管理、スタッフ要件確認 |
| 加算シミュレーター | `addition-simulator` | 実装済 | 現在の人員配置での加算取得可否判定、月間売上シミュレーション |
| 採用計画シミュレーター | `staff-planning` | 実装済 | 仮想スタッフを追加して加算・売上への影響を試算 |
| 財務管理 | `finance` | 実装済 | 経費管理（申請・承認）、損益計算書、キャッシュフロー |

#### 監査・コンプライアンスカテゴリ

| 機能 | メニュー名 | 状態 | 概要 |
|------|-----------|------|------|
| 委員会管理 | `committee` | 実装済 | 虐待防止・身体拘束・運営推進等の委員会議事録管理 |
| 苦情・事故報告 | `incident` | 実装済 | 苦情・事故・ヒヤリハット報告書の作成・ワークフロー |
| 監査書類エクスポート | `audit-export` | 実装済 | 38種類の監査書類のステータス確認、一括出力 |

#### 設定カテゴリ

| 機能 | メニュー名 | 状態 | 概要 |
|------|-----------|------|------|
| 施設情報 | `facility` | 実装済 | 施設名・住所・営業時間・休日・定員・時間枠設定 |

### 4.2 権限モデル

```
管理者（admin/owner/施設管理者）
  └── 全機能にフルアクセス

マネージャー（manager/マネージャー）
  └── 全機能にフルアクセス（管理者と同等）

一般スタッフ（staff/一般スタッフ）
  └── employment_records.permissions で個別に制御
      ├── schedule: 利用調整
      ├── children: 児童管理
      ├── staff: スタッフ管理
      ├── shift: シフト管理
      ├── dashboard: ダッシュボード
      ├── dailyLog: 日誌・連絡帳
      ├── facility: 施設設定
      ├── supportPlan: 個別支援計画
      ├── incident: 苦情・事故報告
      ├── training: 研修記録
      ├── documents: 書類管理
      ├── committee: 委員会
      ├── profitLoss: 損益計算
      ├── cashFlow: キャッシュフロー
      ├── expenseManagement: 経費管理
      └── ...他6種類
```

---

## 5. キャリアアプリ（スタッフ向け）

### 5.1 ホームタブ

- **所属施設一覧**: 現在所属している全施設をカード表示
  - 施設名、ロール、雇用形態（常勤/非常勤）
  - 施設コード表示
  - タップで施設のビジネスダッシュボードへ遷移
- **通知センター**: 資格期限警告、施設からのお知らせ、休暇申請結果

### 5.2 キャリアタブ

| 機能 | 状態 | 概要 |
|------|------|------|
| 基本プロフィール | 実装済 | 氏名・住所・生年月日・性別・連絡先 |
| 写真管理 | 実装済 | プロフィール写真アップロード |
| 学歴情報 | 実装済 | 学歴の追加・編集 |
| 家族情報 | 実装済 | 配偶者・扶養家族情報 |
| 保険情報 | 実装済 | 雇用保険・社会保険・基礎年金・マイナンバー |
| 資格管理 | 実装済 | 保有資格の登録・期限追跡 |
| 職歴管理 | 実装済 | 過去の勤務先情報の記録 |
| 実務経験証明書 | **実装済** | **ワンクリック発行依頼**（後述） |
| 履歴書PDF生成 | 実装済 | ワンクリックで履歴書・職務経歴書をPDF出力 |

### 5.3 ワークタブ

| 機能 | 状態 | 概要 |
|------|------|------|
| GPS出退勤 | 実装済 | ジオフェンス付き打刻（施設500m以内で有効） |
| 出勤カレンダー | 実装済 | 月間の勤怠一覧、シフト対比表示 |
| シフト確認 | 実装済 | 公開されたシフトの確認・回答 |
| 希望シフト提出 | 実装済 | AM/PM/終日の勤務希望日を提出 |
| 休暇申請 | 実装済 | 有給・半休・特別休暇・病欠の申請、残日数表示 |

### 5.4 GPS出退勤の仕組み

```
スタッフが「出勤」ボタンをタップ
    │
    ├── navigator.geolocation で現在位置を取得（精度: high, タイムアウト: 15秒）
    │
    ├── Haversine公式で施設との距離を計算
    │
    ├── 距離 ≤ geofence_radius_meters（デフォルト500m）？
    │     ├── YES → 打刻成功、attendance_records に記録
    │     │         geo_validated: true, geo_distance_meters: 実測距離
    │     │
    │     └── NO → 「施設から離れすぎています」警告表示
    │              ただし位置情報が取得できない場合はフォールバック（打刻は許可）
    │
    └── 退勤・休憩開始・休憩終了も同様のフロー
```

---

## 6. 保護者アプリ

### 6.1 機能一覧

| 機能 | URL | 状態 | 概要 |
|------|-----|------|------|
| ダッシュボード | `/parent` | 実装済 | 児童一覧、施設一覧、招待通知 |
| 児童情報 | `/parent/children/[id]` | 実装済 | 基本情報・施設一覧・利用記録・カレンダー |
| 児童登録 | `/parent/children/register` | 実装済 | 児童の新規登録ウィザード |
| 施設詳細 | `/parent/facilities/[facilityId]` | 実装済 | 契約情報、利用記録 |
| 利用記録 | `/parent/facilities/[facilityId]/records` | 実装済 | 月間サービス記録表、電子署名、PDF出力 |
| 施設チャット | `/parent/facilities/[facilityId]/chat` | 実装済 | 施設スタッフとのリアルタイムチャット |
| 連絡（欠席/利用申請） | `/parent/facilities/[facilityId]/contact` | 実装済 | 欠席連絡・利用希望・一般メッセージ送信 |
| 招待受理 | `/parent/invitation/accept` | 実装済 | 施設からの契約招待の受理 |
| 利用申請 | `/parent/children/[id]/usage-request` | 実装済 | カレンダーベースの利用申請 |

### 6.2 保護者-施設連携フロー

```
1. 施設が保護者にメールで招待を送信
2. 保護者が招待リンクをクリック → アカウント作成 or ログイン
3. 招待を承認 → contracts テーブルに契約レコード作成
4. 以降、保護者は:
   ├── 利用スケジュールを確認
   ├── 欠席連絡を送信（スケジュールを自動更新）
   ├── 追加利用を申請
   ├── 施設とチャット
   ├── 月間サービス記録に電子署名
   └── 連絡帳を確認
```

---

## 7. 実務経験証明書の発行フロー

### 結論: ワンクリック発行依頼は実装済み

#### 全体フロー

```
┌─────────────────────────────────────────────────────────┐
│ ステップ1: スタッフが職歴情報を入力                          │
│ キャリアアプリ → キャリアタブ → 職歴セクション                 │
│                                                         │
│ 入力項目:                                                │
│  ・施設名（必須）・法人名・法人所在地・電話番号                  │
│  ・代表者氏名・事業種別（10種類から選択）                      │
│  ・勤務期間（開始日〜終了日）・実勤務日数・週平均勤務日数        │
│  ・職名・雇用形態・業務内容                                  │
│  ・証明書送付先メールアドレス・担当者名                        │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ ステップ2: 「発行依頼」ボタンをクリック（ワンクリック）          │
│                                                         │
│ システム処理:                                              │
│  1. 一意の署名トークンを生成                                 │
│  2. work_experience_records.status を 'pending' に更新     │
│  3. Resendメールサービスで施設宛にメール送信                   │
│     ・メール件名・本文はカスタマイズ可能                       │
│     ・署名リンク（/sign/{token}）を含む                      │
│     ・有効期限: 30日間                                     │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ ステップ3: 施設管理者がメールのリンクをクリック                 │
│ /sign/[token] ページで証明書内容を確認                       │
│                                                         │
│ 管理者の操作:                                              │
│  ・署名者名を入力                                          │
│  ・署名者役職を入力                                         │
│  ・印鑑テキストを入力 → 赤い角印画像を自動生成                 │
│  ・証明書プレビューを確認                                    │
│  ・「署名する」ボタンで承認 or 「却下」ボタンで却下             │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ ステップ4: PDF証明書のダウンロード                           │
│                                                         │
│ スタッフ側:                                               │
│  ・ステータスが「署名済み」に変更                             │
│  ・ダウンロードボタンからPDFを取得                            │
│  ・PDF内容: A4縦、和暦日付、全項目+印鑑画像入り               │
│                                                         │
│ ファイル名: 実務経験証明書_[申請者名]_[施設名].pdf              │
└─────────────────────────────────────────────────────────┘
```

#### ステータス遷移

| ステータス | 表示 | 意味 |
|-----------|------|------|
| `draft` | 下書き（灰色） | 情報入力中 |
| `pending` | 承認待ち（黄色） | メール送信済み、施設の対応待ち |
| `signed` | 署名済み（緑） | 施設管理者が署名完了、PDF取得可能 |
| `rejected` | 却下（赤） | 施設管理者が却下、理由が記録される |

#### PDF証明書に含まれる情報

- 申請者情報: 氏名、フリガナ、生年月日（和暦）
- 施設・法人情報: 施設名、法人名、所在地、電話番号、代表者氏名、事業種別
- 勤務情報: 勤務期間、実勤務日数、週平均勤務日数、職名、雇用形態、業務内容
- 証明情報: 署名者名、署名者役職、電子印鑑（赤い角印画像）、証明日

---

## 8. 監査書類のワンクリック出力

### 結論: 部分的に実装済み（データがある書類は一括出力可能）

### 8.1 AuditExportView（監査書類エクスポート画面）

38種類の監査書類を8カテゴリに分類し、ステータス管理と一括出力を提供。

#### カテゴリと書類数

| カテゴリ | 書類数 | Excel出力 | 印刷出力 | ステータス管理 |
|---------|--------|----------|---------|-------------|
| 運営・管理体制 | 6 | - | - | 有無チェックのみ |
| 人員配置・勤務 | 5 | **勤務体制一覧表** / **出勤簿** | - | データ有無で自動判定 |
| サービス提供 | 5 | **サービス提供記録** | - | データ有無で自動判定 |
| 安全管理・事故対応 | 6 | - | **事故報告書** | データ有無で自動判定 |
| 経理・財務 | 5 | **月次財務サマリー** | - | データ有無で自動判定 |
| 児童関連書類 | 5 | - | - | 有無チェックのみ |
| 研修・教育 | 3 | - | **研修議事録** | データ有無で自動判定 |
| 委員会・会議 | 3 | - | **委員会議事録** | データ有無で自動判定 |

### 8.2 実際に出力可能な書類

#### Excel（.xlsx）で直接ダウンロード可能:

| 書類名 | ファイル名 | 内容 |
|--------|-----------|------|
| 勤務体制一覧表 | `勤務体制一覧表_YYYY年MM月.xlsx` | スタッフ配置表（人員種別・資格・FTE・担当加算） |
| 出勤簿 | `出勤簿_YYYY年MM月.xlsx` | スタッフ別月間出勤記録（出退勤時刻・休憩・残業） |
| 月次財務サマリー | `財務サマリー_YYYY年度.xlsx` | 月次PL・経費内訳（最大3シート） |
| サービス提供記録（個別） | `サービス提供記録_児童名_YYYY年MM月.xlsx` | 児童別月間利用実績 |
| サービス提供記録（一括） | `月次実績記録票_YYYY年MM月_全児童.xlsx` | 全児童の月間利用実績（サマリー+個別シート） |

#### ブラウザ印刷（→PDF保存）で出力可能:

| 書類名 | 形式 | 内容 |
|--------|------|------|
| 事故・苦情報告書 | A4縦HTML | 事故概要・負傷詳細・原因分析・再発防止策・印鑑欄 |
| 研修議事録 | A4縦HTML | 研修概要・参加者一覧・内容要約・評価方法・印鑑欄 |
| 委員会議事録 | A4縦HTML | 出席者・議題・決定事項・報告事項・アクションアイテム・印鑑欄 |
| サービス提供記録（印刷） | A4横HTML | 日次利用記録表・出欠色分け・印鑑欄 |
| 業務日誌 | PDF（jsPDF） | 日付・天気・出欠・活動記録・安全確認 |
| 個別支援計画書 | PDF（jsPDF） | 児童情報・目標・支援内容・家族連携・署名欄 |

### 8.3 「監査パッケージ生成」ボタン

`AuditExportView` に「監査パッケージ生成」ボタンがあり、押すと:
1. 勤務体制一覧表（Excel）を出力
2. 財務サマリー（Excel）を出力
3. 500msの間隔で順次ダウンロード

**現時点の制限**: 全38種類が一括ZIPになるわけではなく、データが存在する書類のみ個別ダウンロード。

---

## 9. 減算リスク検出エンジン

### deductionEngine.ts

リアルタイムで以下の減算リスクを自動検出し、ダッシュボードにアラート表示:

| 減算種別 | 影響率 | 検出条件 | 重大度 |
|---------|--------|---------|--------|
| **定員超過減算** | 報酬の70% | 当日の利用児童数 > 施設定員 | critical |
| **個別支援計画未作成減算** | 報酬の50-70% | 契約中の児童に有効な支援計画がない | warning/critical |
| **人員欠如減算** | 報酬の70% | 配置基準未充足（2名未満 or 常勤専従なし） | critical |
| **サービス管理責任者欠如減算** | 報酬の70% | 児童発達支援管理責任者が未配置 | critical |
| **自己評価結果未公表減算** | 報酬の15% | 自己評価の公表日がnull | warning |

### qualificationTracker.ts

スタッフの資格期限を追跡:
- 180日先まで先読みしてアラート生成
- レベル: `expired`（期限切れ）→ `urgent`（30日以内）→ `warning`（90日以内）→ `info`

### committeeTracker.ts

法定委員会の開催状況を追跡:

| 委員会 | 開催頻度要件 | アラート |
|--------|------------|---------|
| 虐待防止委員会 | 四半期に1回以上 | 14日以内に期限切れ |
| 身体拘束適正化委員会 | 四半期に1回以上 | 14日以内に期限切れ |
| 運営推進会議 | 半年に1回以上 | 14日以内に期限切れ |

---

## 10. 加算・請求システム

### 10.1 マスタデータ

| テーブル | 件数 | 内容 |
|---------|------|------|
| `service_types` | 6種 | 児発・放デイ・保訪・居訪・多機能・共生型 |
| `regional_units` | 5段階 | 1級地〜4級地+地方（地域区分別単価係数） |
| `base_rewards` | 多数 | サービス種別×時間区分×定員別の基本報酬単位 |
| `addition_categories` | 10+ | 人員配置・専門職・家族支援・送迎・行動援護等 |
| `additions` | 30+ | 個別加算マスタ（単位数/率、排他制約含む） |
| `deductions` | 5種 | 減算マスタ（定員超過・人員欠如等） |

### 10.2 加算シミュレーター

```
入力:
  ├── 現在のスタッフ構成（資格・経験年数・勤務形態）
  ├── 利用児童数（AM/PM別）
  ├── 地域区分
  └── サービス種別

出力:
  ├── 取得可能な加算一覧（判定理由付き）
  ├── 基本報酬単位数
  ├── 加算合計単位数
  ├── 月間売上見込み（円）
  └── 最適化提案
```

### 10.3 採用計画シミュレーター

仮想スタッフを追加して、その人件費と加算取得による売上増を比較:
- 給与/時給設定
- 資格・経験年数設定
- FTE自動計算
- 採用前後の月間売上差分表示

---

## 11. データベース設計

### 11.1 テーブル総数: 62テーブル

#### コアエンティティ（7テーブル）
`facilities`, `users`, `staff`, `children`, `employment_records`, `contracts`, `leads`

#### 施設設定（3テーブル）
`facility_settings`, `facility_settings_history`, `facility_time_slots`

#### 人員・シフト（7テーブル）
`staff_personnel_settings`, `staff_leave_settings`, `shifts`, `shift_patterns`, `monthly_shift_schedules`, `shift_confirmations`, `work_schedule_reports`

#### 休暇・勤怠（5テーブル）
`leave_requests`, `paid_leave_balances`, `shift_availability_submissions`, `shift_availability_deadlines`, `attendance_records`

#### スケジュール・利用記録（3テーブル）
`schedules`, `usage_records`, `contact_logs`

#### 請求・加算（10テーブル）
`service_types`, `regional_units`, `base_rewards`, `addition_categories`, `additions`, `deductions`, `child_additions`, `facility_addition_settings`, `daily_addition_records`, `monthly_revenue_estimates`

#### 書類・記録（7テーブル）
`child_documents`, `document_templates`, `daily_logs`, `support_plan_files`, `work_experience_records`, `facility_children_settings`, `daily_staffing_compliance`

#### コミュニケーション（5テーブル）
`chat_messages`, `connect_meetings`, `connect_meeting_date_options`, `connect_meeting_participants`, `connect_meeting_responses`

#### 財務（2テーブル）
`expenses`, `monthly_financials`

#### コンプライアンス（3テーブル）
`incident_reports`, `training_records`, `committee_meetings`

#### ナレッジ・規定（4テーブル）
`knowledge_categories`, `knowledge_articles`, `company_regulations`, `regulation_categories`

#### システム・認証（6テーブル）
`otp_codes`, `companies`, `system_config`, `platform_invitation_tokens`, `notifications`, `facility_work_tool_settings`

### 11.2 主要リレーションシップ

```
facilities
├── employment_records → users（スタッフ所属）
├── children → owner_profile_id → users（保護者）
├── contracts（児童×施設の利用契約）
├── schedules → children（日次スケジュール）
├── usage_records → schedules（利用実績）
├── contact_logs → children（連絡帳）
├── chat_messages → users（チャット）
├── shifts → staff（シフト）
├── attendance_records → users（出退勤）
├── leave_requests → users（休暇申請）
├── daily_logs（業務日誌）
├── incident_reports（事故報告）
├── training_records（研修記録）
├── committee_meetings（委員会）
├── expenses → monthly_financials（経費→財務）
├── child_additions → additions（児童別加算）
├── facility_addition_settings → additions（施設加算設定）
└── daily_staffing_compliance（日次配置コンプライアンス）
```

---

## 12. セキュリティ

### 12.1 認証

| 項目 | 実装 |
|------|------|
| パスワードハッシュ | bcrypt（bcryptjsライブラリ） |
| セッション管理 | Supabase Auth + localStorage |
| OTP認証 | メールベースOTP（6桁コード） |
| Passkey | WebAuthn対応（登録・認証APIあり） |

### 12.2 RLS（行レベルセキュリティ）

57テーブルに `facility_id` ベースのテナント分離ポリシーを適用:

```sql
-- 典型的なRLSパターン
CREATE POLICY "facility_isolation" ON テーブル名
  FOR ALL
  USING (
    facility_id IN (
      SELECT er.facility_id
      FROM employment_records er
      WHERE er.user_id = auth.uid()::text
      AND er.end_date IS NULL
    )
  );
```

### 12.3 Middleware

- 保護ルート（`/business`, `/career`, `/parent`）にセキュリティヘッダー付与
- `Cache-Control: no-cache, no-store, must-revalidate`
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `Referrer-Policy: strict-origin-when-cross-origin`

---

## 13. 現時点の制限事項・未完成機能

### 13.1 動作するがデータ依存の機能

| 機能 | 状況 | 備考 |
|------|------|------|
| ダッシュボードKPI | UI完成、データ投入で動作 | スケジュール・児童データが必要 |
| 加算シミュレーター | UI完成、マスタデータ依存 | additions テーブルにマスタ投入が必要 |
| 減算リスク検出 | ロジック完成 | 児童・スタッフデータがないとアラートが出ない |
| サービス提供記録出力 | 完全動作 | usage_records にデータが必要 |
| 財務サマリー出力 | 完全動作 | monthly_financials にデータが必要 |

### 13.2 UI実装済みだが出力未対応の書類

以下の書類は「書類管理」画面でステータス追跡は可能だが、システムからの自動生成はまだない:

- 運営規程
- 重要事項説明書
- 利用契約書
- 個人情報同意書
- 秘密保持誓約書
- 感染症対策マニュアル
- 安全チェックリスト
- 避難訓練記録
- 受給者証コピー
- 医療情報

これらは外部で作成した書類をアップロードして管理する運用を想定。

### 13.3 今後の拡張候補

| 機能 | 優先度 | 概要 |
|------|--------|------|
| 国保連請求データCSV出力 | 高 | 月次請求データの国保連フォーマット出力 |
| Supabase Auth完全移行 | 高 | localStorage → JWT セッション完全移行 |
| 監査パッケージZIP一括出力 | 中 | 全書類をZIPにまとめてダウンロード |
| リアルタイムチャット通知 | 中 | Supabase Realtime によるプッシュ通知 |
| PWAオフライン対応 | 低 | Service Workerによるオフラインキャッシュ |
| ネイティブアプリ | 低 | Capacitorによるios-apps（フォルダ存在、未完成） |

---

## 付録: ファイル構成（主要ディレクトリ）

```
src/
├── app/
│   ├── business/page.tsx          # 施設管理ダッシュボード（21タブ切替）
│   ├── career/page.tsx            # キャリアアプリ（4タブ）
│   ├── parent/                    # 保護者アプリ（10ページ）
│   ├── api/                       # APIルート（認証・メール・PDF生成）
│   └── facility/                  # 施設登録・招待
├── components/
│   ├── common/Sidebar.tsx         # サイドバーナビゲーション
│   ├── dashboard/                 # ダッシュボード
│   ├── schedule/                  # スケジュール管理
│   ├── children/                  # 児童管理
│   ├── staff/                     # スタッフ・シフト・休暇
│   ├── logs/                      # 日誌・連絡帳
│   ├── support-plan/              # 個別支援計画
│   ├── documents/                 # 書類管理
│   ├── addition/                  # 加算設定
│   ├── simulation/                # シミュレーター
│   ├── staffing/                  # 人員配置・勤務体制
│   ├── training/                  # 研修記録
│   ├── committee/                 # 委員会管理
│   ├── incident/                  # 苦情・事故報告
│   ├── finance/                   # 財務管理
│   ├── audit/                     # 監査エクスポート
│   ├── records/                   # サービス提供記録
│   ├── chat/                      # チャット
│   └── personal/                  # キャリア個人系（証明書・休暇申請等）
├── hooks/                         # カスタムフック（ドメイン別8分割）
├── lib/
│   ├── deductionEngine.ts         # 減算リスク検出
│   ├── qualificationTracker.ts    # 資格期限追跡
│   ├── committeeTracker.ts        # 委員会追跡
│   ├── excelEngine.ts             # Excel出力エンジン
│   ├── wordEngine.ts              # Word/印刷出力エンジン
│   ├── serviceRecordGenerator.ts  # サービス提供記録生成
│   ├── geoFence.ts                # GPSジオフェンス
│   ├── payrollCalculator.ts       # 給与計算
│   └── supabase.ts                # Supabaseクライアント
├── contexts/AuthContext.tsx        # 認証コンテキスト
├── types/index.ts                 # 型定義
└── utils/
    ├── additionJudgment.ts        # 加算自動判定
    └── pdfExport.ts               # PDF出力
```

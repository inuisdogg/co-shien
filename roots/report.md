# Roots プロジェクト総合レポート

**プロジェクト名**: kidos (co-shien/Roots) - 障害児通所支援事業所向けSaaS
**レポート作成日**: 2026年2月25日
**作成者**: CTO / Claude Code（自律開発チーム統括）

---

## エグゼクティブサマリー

kidosプロジェクトは、Next.js 14 + Supabase + TypeScriptで構築された障害児通所支援事業所向けSaaSであり、施設管理・スタッフ管理・児童管理・加算シミュレーション等の主要機能がPhase 1 (MVP) として動作する状態にある。しかし、**セキュリティ基盤に致命的な脆弱性**（パスワードハッシュがソルトなしSHA-256、Supabase Auth未使用、RLSが実質無効）が存在し、本番運用前に必ず修正が必要である。法規制面では加算ライフサイクル管理の設計は優れているものの、**減算リスクの自動検出機能が皆無**であり、定員超過減算（70%）や支援計画未作成減算（30-50%）の発生を防止できない。コードアーキテクチャでは`useFacilityData`（2,633行）のGod Hook化と、全42ページの`'use client'`化がスケーラビリティの障壁となっている。

---

## 各領域の評価

| 領域 | 評価 | 概要 |
|------|------|------|
| コード品質 | **C** | God Hook化、121箇所のconsole.log、2,974行のページコンポーネント。動作はするが保守性に深刻な問題 |
| セキュリティ | **D** | SHA-256ソルトなし、RLS全許可、APIルート認証なし、セッションがlocalStorageのみ。本番運用不可 |
| 仕様準拠度 | **B** | Phase 1の主要機能は実装済み。ただしstaffテーブル移行が中途半端、Phase 2-3機能の一部が混入 |
| 法規制対応 | **C** | 加算設計は優秀だが、減算検出がゼロ。帳票Excel出力未完成。児発管資格期限管理なし |
| デザイン品質 | **B+** | Tailwind CSSで統一感あり。時間枠未設定時のガイダンス実装済み。レスポンシブ対応あり |
| ビルド健全性 | **B+** | TypeScriptエラー1件、ビルドエラー1件（いずれも未作成のPhase 3チャットコンポーネント）。それ以外はクリーン |

---

## 緊急課題 (P0) - 即時対応が必要

### セキュリティ

| # | 課題 | 対象ファイル | 詳細 |
|---|------|-------------|------|
| 1 | **パスワードハッシュがSHA-256ソルトなし** | `src/utils/password.ts:16` | レインボーテーブル攻撃に完全に脆弱。bcrypt/Argon2に移行し、全ユーザーにパスワード再設定を要求 |
| 2 | **`select('*')`でpassword_hashがクライアントに送信** | `src/contexts/AuthContext.tsx:140,149,223,234,322,333` | 必要なカラムのみ指定するよう変更 |
| 3 | **セッション管理がlocalStorageのみ** | `src/contexts/AuthContext.tsx:82-113` | localStorageの書き換えで任意のユーザーになりすまし可能。Supabase Auth統合またはサーバーサイドセッション導入 |
| 4 | **Supabase Anon KeyとService Role Keyがソースコードにハードコード** | `src/lib/supabase.ts:4-5`, `.env.local:34` | 即座にキーをローテーション。コードからハードコード値を完全削除 |
| 5 | **主要テーブル（users, staff, children, facilities）にRLSなし** | 初期スキーマ | RLS有効化 + 適切なポリシー設定 |
| 6 | **全APIルートに認証チェックなし** | `src/app/api/` (10エンドポイント全て) | 誰でもOTP送信、パスキー操作、メール送信、PDF生成が可能 |
| 7 | **RLSポリシー273箇所が`USING(true)`で全許可** | 43マイグレーションファイル | facility_id基準の適切なポリシーに書き換え |
| 8 | **招待トークンが署名なしBase64エンコード** | `src/utils/staffInvitationService.ts:358-399` | 偽造可能。JWT/HMAC署名付きトークンに変更 |

### 法規制

| # | 課題 | 詳細 |
|---|------|------|
| 9 | **減算リスク自動検出機能がゼロ** | 定員超過減算（70%）、支援計画未作成減算（30-50%）、未公表減算（x85/100）等の検出機能が一切なし |
| 10 | **児発管の資格有効期限チェックなし** | 更新研修未受講による資格失効を検知できない（東京都の最重要指摘事項） |

---

## 重要課題 (P1) - 1-2スプリント以内に対応

### アーキテクチャ

| # | 課題 | 対象ファイル | 詳細 |
|---|------|-------------|------|
| 11 | **`useFacilityData.ts`が2,633行のGod Hook** | `src/hooks/useFacilityData.ts` | 10ドメインの責務を1フックに集約。9個のフックに分割すべき |
| 12 | **全42ページが`'use client'`** | `src/app/` 全ページ | Next.js App Routerのサーバーコンポーネントの利点を全く活用していない |
| 13 | **初回マウント時に10テーブルを一括フェッチ** | `useFacilityData.ts` | 未使用データもメモリに常駐。遅延ロードに移行すべき |
| 14 | **console.log/warn/errorが121箇所** | `useFacilityData.ts` | デバッグ情報がパフォーマンスとセキュリティのリスク |

### データベース

| # | 課題 | 詳細 |
|---|------|------|
| 15 | **staffテーブルとusers+employment_recordsの二重管理** | 15ファイルがstaffテーブル、34ファイルがusersテーブルを参照。AuthContextでフォールバック認証も現役 |
| 16 | **テストデータがマイグレーションに混入（20件以上）** | 本番デプロイ時に不要なテストデータが挿入される |
| 17 | **マイグレーション117ファイルの肥大化** | スクワッシュマイグレーション実施が必要 |
| 18 | **SUPABASE_SERVICE_ROLE_KEY変数名不一致** | `.env.local`の`SUPABASE_SERVICE_KEY`とコードの`SUPABASE_SERVICE_ROLE_KEY`が不一致 |

### 法規制

| # | 課題 | 詳細 |
|---|------|------|
| 19 | **定員超過チェックバリデーション未実装** | 当日150%超過、3ヶ月平均105%超過の自動検出 |
| 20 | **個別支援計画の期限追跡と減算アラート未実装** | 6ヶ月PDCAサイクルの追跡機能 |
| 21 | **人員欠如のリアルタイム検知未実装** | `daily_staffing_compliance`テーブルは存在するがシフトデータとの突合ロジック未連結 |
| 22 | **勤務体制一覧表のExcel自動生成未実装** | 行政提出で最も頻繁に使用される帳票 |

---

## 中期課題 (P2) - 1-3ヶ月以内に対応

### コード品質

| # | 課題 | 詳細 |
|---|------|------|
| 23 | `any`型が6箇所（snake_case変換部分） | 型安全性の確保 |
| 24 | camelCase/snake_case変換が手動で重複 | 共通変換レイヤーの構築 |
| 25 | `types/index.ts`にランタイム定数とビジネスロジック関数が混在 | 型定義ファイルの分割 |
| 26 | Child型73フィールド、Staff型55フィールドの巨大型 | ドメイン別に分割 |
| 27 | `career/page.tsx`が2,974行の巨大ページ | コンポーネント分割 |
| 28 | 開発モードバイパスが`NEXT_PUBLIC_`環境変数で制御 | クライアントに露出している |

### データベース

| # | 課題 | 詳細 |
|---|------|------|
| 29 | `facilityDataService.ts`が完全未実装（スタブのみ） | 不要なら削除 |
| 30 | Supabaseクライアント初期化パターンが3種類混在 | 統一化 |
| 31 | プロジェクトルート直下に散在する30以上のSQLファイル | 整理 |
| 32 | デジタル署名がBase64エンコードのみ | RSA/JWS導入 |
| 33 | メール/SMS送信が未実装（console.logのみ） | Resend統合完了 |

### 法規制

| # | 課題 | 詳細 |
|---|------|------|
| 34 | 実施加算（送迎・家族支援・関係機関連携）の判定ロジック未実装 | 回数制限チェック含む |
| 35 | 5領域未公表減算の検出機能なし | 公表URL管理フィールド追加 |
| 36 | BCP/虐待防止/身体拘束の義務実施管理画面なし | 各1%減算リスク |
| 37 | サービス提供実績記録票の自動生成なし | 国保連請求の根幹書類 |
| 38 | 15日締切の閉庁日補正なし | 土日祝の場合の直前開庁日算出 |

---

## 長期改善 (P3) - 半年以内

| # | 課題 | 詳細 |
|---|------|------|
| 39 | Next.js Server Components / Server Actions の活用 | SSR/SSGによるパフォーマンス向上 |
| 40 | Supabase Auth統合（パスキー/OTP/メール認証の統一） | セキュリティ基盤の刷新 |
| 41 | IDの生成を`Date.now()`からUUIDに変更 | 衝突リスクの排除 |
| 42 | Staff型→users+employment_records完全移行 | staffテーブルの完全廃止 |
| 43 | middleware.tsでのサーバーサイド認証チェック | 現在は認証チェックなし |
| 44 | PDF出力の日本語フォント対応 | 現在helveticaで日本語文字化け |
| 45 | 保育所等訪問支援の30分ルール管理 | 令和6年度改定対応 |
| 46 | CI/CDパイプラインの構築 | TypeScriptチェック、ESLint、テスト自動化 |

---

## 仕様と実装の整合性

### Phase 1 (MVP) - 実装済み機能

| 機能 | 実装状態 | ルーティング |
|------|---------|------------|
| ダッシュボード | 実装済み | `business/page.tsx` → `DashboardView` |
| 利用予約・スケジュール | 実装済み | `business/page.tsx` → `ScheduleView` |
| 児童管理 | 実装済み | `business/page.tsx` → `ChildrenView` |
| スタッフマスタ | 実装済み | `business/page.tsx` → `StaffMasterView` |
| シフト管理 | 実装済み | `business/page.tsx` → `ShiftManagementView` |
| 施設設定 | 実装済み | `business/page.tsx` → `FacilitySettingsView` |
| 実績と連絡帳 | 実装済み | `business/page.tsx` → `DailyLogView` |
| 加算シミュレーター | 実装済み | `business/page.tsx` → `AdditionSimulatorView` |
| 採用計画シミュレーター | 実装済み | `business/page.tsx` → `StaffPlanningSimulator` |
| 保護者アプリ (基本) | 部分実装 | `parent/` 配下に15ページ |
| キャリアアカウント | 部分実装 | `career/` 配下に4ページ |

### Phase 1 - 未実装/不完全な機能

| 機能 | 状態 | 備考 |
|------|------|------|
| 個別支援計画 | Sidebarに定義あり・ページ未実装 | `support-plan`タブはSidebarにPhase 1として定義されているがrenderContentにcaseなし |
| 書類管理 | 型定義のみ | 38種書類の定義はあるが管理UIなし |
| 苦情/事故報告 | 型+テンプレート定義のみ | 入力・閲覧画面なし |
| 研修記録 | テーブル定義のみ | 画面なし |
| 委員会管理 | テーブル定義のみ | 画面なし |
| 経費管理 | 型定義+DB定義のみ | 画面なし |
| 売上分析 | 未実装 | ダッシュボードにKPIはあるが詳細分析なし |

### フェーズ管理の整合性

```env
NEXT_PUBLIC_FEATURE_PHASE=1  # .env.local
```

- `parent/page.tsx:22`: `FEATURE_PHASE >= 3` でチャット機能を制御 → 適切
- `Sidebar.tsx:40`: `support-plan: 1` でPhase 1に含める → 適切だがrenderContent未対応
- Phase 2-3の機能（チャット、送迎ルート、コネクト）は適切にフラグ制御されている

---

## 推奨アクションプラン

### 即座に実行（今週中）

1. **Supabase キーのローテーション**: ソースコードにハードコードされているAnon Key/Service Role Keyを無効化し、新キーを発行。`.env.local`のみで管理
2. **`select('*')`の修正**: AuthContext.tsxの8箇所で`select('id, email, name, role, ...')`に変更し、password_hashの送信を停止
3. **`npx tsc --noEmit` と `npm run build` を手動実行**: ビルドエラーの有無を確認

### 第1スプリント（1-2週間）

4. パスワードハッシュをbcrypt/Argon2に移行（+既存ユーザーへの再設定依頼フロー）
5. RLSポリシーを`facility_id`基準の適切なポリシーに書き換え（少なくともusers, children, staffテーブル）
6. APIルートに認証ミドルウェア追加（少なくともOTP送信とPDF生成）

### 第2スプリント（3-4週間）

7. `useFacilityData.ts`を9フックに分割
8. 定員超過チェックバリデーション実装
9. 個別支援計画の期限追跡アラート実装
10. 児発管の資格有効期限管理追加

### 第3スプリント（5-6週間）

11. staffテーブル→users+employment_records統一（15ファイル修正）
12. 勤務体制一覧表のExcel自動生成
13. テストデータのマイグレーションからの分離

---

## 付録: 監査チーム構成

本レポートは以下の5つの専門エージェントによる並行監査の結果を統合したものである:

| エージェント | 担当領域 | 検査項目数 |
|-------------|---------|-----------|
| フロントエンド開発者 | コンポーネント構造、フック品質、型定義、認証フロー | 20項目 |
| バックエンド開発者 | DB監査、API、RLS、マイグレーション、サービス層 | 20項目 |
| 仕様書検証担当 | shiyou.md/REVIEW_PLAN.md vs 実装、フェーズ管理 | 検証実施 |
| 法規制コンプライアンス担当 | 人員配置、加算、減算、帳票 | 改善提案A-1〜C-5 |
| QAエンジニア | ビルド検証、プロジェクト構造 | 静的分析のみ（Bash権限制限） |

---

*本レポートは Claude Code Max Plan のトークンを使用し、5エージェント並行実行で生成されました。*

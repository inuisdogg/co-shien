# 既知の課題・未実装機能一覧

## 1. マスターデータ整合性違反

### 問題の概要
マスターデータ（施設設定、時間枠、定員等）が未設定の状態でも、画面が動作してしまう問題がある。本来はマスターデータが未設定の場合、関連機能は表示せずガイダンスを表示すべき。

### 具体的な問題

| 問題 | 影響 | 対象ファイル |
|------|------|-------------|
| 時間枠未設定でも「午前/午後」が表示される | ハードコードされた時間枠がDB未連携で表示 | ScheduleView, DashboardView |
| 定員未設定でも稼働率が計算される | 0/0 やゼロ除算のリスク | dashboardCalculations.ts |
| サービス種別未設定で加算一覧が表示 | 不正確な加算情報が表示 | AdditionCatalogView |
| 地域区分未設定で単価が計算 | デフォルト値が使用される | RevenueAnalytics |
| facility_time_slotsテーブルの存在未確認 | マイグレーション漏れの可能性 | migrations/ |
| 営業時間未設定でカレンダーが動作 | 不正確なシフト管理 | シフト管理、カレンダー |

### 対策
- 全画面で `isConfigured` フラグによる条件分岐を実装
- 未設定時は `<SetupGuidance>` コンポーネントを表示
- 計算処理でも防御的プログラミングを実施

---

## 2. スタッフテーブルの移行問題

### 現状の問題
- `staff` テーブル（レガシー）と `employment_records` テーブル（新設計）が共存
- 施設管理者が「新規追加」ボタンで直接staffテーブルに挿入している
- キャリアアカウント（usersテーブル）が作られない

### あるべき姿
1. スタッフの「新規追加」→「招待」に変更
2. メールアドレス（または電話番号）入力 → 招待メール送信
3. スタッフが招待リンクをクリック → キャリアアカウント作成（またはログイン）
4. `employment_records` に雇用関係が作成される

### 移行計画
- `staff` テーブルの使用を非推奨化
- `employment_records` 経由のフローに統一
- 既存データの移行スクリプトが必要

---

## 3. 未実装機能一覧

### Phase 1（MVP）で未完成の機能

| 機能 | 状態 | 備考 |
|------|------|------|
| ログイン機能（JWT等） | 未実装 | アカウント作成機能も未実装 |
| 個別支援計画 | 簡易版のみ | PDFアップロード等で対応可能 |
| 基本書類出力 | 未実装 | ヒヤリハット、事故報告書、契約同意書 |
| 保護者向けポータル | 未実装 | 欠席連絡、予約申し込み |
| ファイルアップロード機能 | 未実装 | 受給者証画像等 |
| 通知機能 | 未実装 | メール/SMS通知 |

### Phase 2で予定の機能

| 機能 | 状態 | 備考 |
|------|------|------|
| 苦情・事故報告（incident reporting） | 未実装 | 運営指導で必須書類 |
| 委員会管理（committee management） | 未実装 | 虐待防止委員会、身体拘束廃止委員会等 |
| 研修記録 | 未実装 | BCP研修、虐待防止研修等の管理 |
| 指定申請・変更届出力 | 未実装 | 複雑なExcel（R07版）へのデータ流し込み |
| 監査準備（audit） | 未実装 | 行政指導用チェックリスト |
| 経営設定 | 部分的 | 加算分析や売上シミュレーション |

### Phase 3で予定の機能

| 機能 | 状態 | 備考 |
|------|------|------|
| 保護者アプリ（Client側） | 未実装 | 欠席連絡、予約申し込み、チャット |
| 送迎ルート最適化 | 未実装 | ルート最適化、乗車位置マップ |
| コネクト（複数施設間連携） | 未実装 | リード管理含む |

---

## 4. データモデルの課題

### 児童テーブルの所有権問題
- 現状: 施設が児童情報を「所有」しており、施設を辞めるとデータが分断
- 目標: 保護者（利用者アカウント）が児童データを所有し、施設にアクセス権を付与する形
- `children` テーブルに `owner_profile_id` の追加が必要
- `contracts` テーブル経由での施設-児童紐付けに移行

### 契約管理の不足
- `contracts` テーブルが設計済みだが、既存コードとの統合が未完了
- 契約ステータス（pending/active/terminated）に基づく権限制御が未実装
- 契約期間外のデータアクセス遮断（個人情報保護）が未実装

### 加算ステータス管理
- 加算のライフサイクル（Planned → Applying → Active → Inactive）が未実装
- 15日締切の業務ルールがシステムに組み込まれていない
- 売上シミュレーションが即時反映型のまま

---

## 5. フロントエンドの課題

### ハードコードされた値
- 時間枠（午前/午後）がDBではなくコード内でハードコード
- デフォルト値が未設定時に使用されている箇所が多い
- サービス種別に依存しないジェネリックな表示になっている箇所

### コンポーネントの整合性
- スタッフ管理画面が旧staffテーブルを参照している箇所
- employment_records経由のデータ取得に統一が必要
- AuthContextでの権限管理が不十分（利用者アカウントとスタッフアカウントの区別）

---

## 6. セキュリティの課題

| 課題 | 対策状況 |
|------|---------|
| Row Level Security (RLS) | 一部テーブルのみ設定済み |
| 招待トークンのセキュリティ | 設計済み・未実装 |
| 契約期間外のデータアクセス遮断 | 未実装 |
| 監査ログ（アクセス履歴） | 設計済み・未実装 |
| メール送信のレート制限 | 未実装 |

---

## 7. 優先的に対処すべき項目

### 最優先（Phase R1相当）
1. facility_time_slotsテーブルの確認とマイグレーション
2. 施設設定の未設定時ガイダンス表示
3. ダッシュボードの稼働率計算の防御的実装

### 高優先（Phase R2-R3相当）
4. staffテーブルからemployment_recordsへの移行
5. 児童テーブルの所有権モデル移行
6. 基本的な認証・認可の実装

### 中優先（Phase R4-R6相当）
7. 加算ステータスのライフサイクル実装
8. 書類自動生成の基盤実装
9. 報酬計算ロジックの実装

---

*最終更新: 2026-02-25*

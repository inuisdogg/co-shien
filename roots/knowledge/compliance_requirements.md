# コンプライアンス・書類自動生成要件

## 概要

本ドキュメントは、regulatory_compliance_design.md に基づく行政提出書類・運営記録の自動生成システムの設計要件をまとめたものである。

---

## 最重要コンセプト

### 1. コンプライアンス（法令順守）の厳密な反映
加算の取得や減算の適用は、UI上のチェックボックス操作だけで即座に売上予測等に反映されてはならない。「行政への届出（毎月15日締切）→ 受理 → 翌月適用」という実務プロセスをシステムロジックとして実装すること。

### 2. 完全な履歴管理（Time Travel）
行政監査に対応するため、「過去の特定日（例：2年前の4月1日）」における事業所の体制、職員配置、加算取得状況を完全に再現し、その時点のデータで書類を出力できること。

---

## 加算ステータスのライフサイクル管理

加算は「チェック = 即売上」ではない。以下の4段階のステータス管理を実装する。

| ステータス | 意味 | 売上への反映 |
|-----------|------|------------|
| `Planned` | 計画中 | 売上予測に含めない |
| `Applying` | 届出準備中 | 書類出力可能。前月15日までに提出が必要 |
| `Active` | 適用中 | 行政受理済み。売上に反映 |
| `Inactive` | 廃止/停止 | 売上から除外 |

### 15日締切の業務ルール
- 加算を新規取得・区分変更する場合、**前月の15日まで**に行政へ変更届を提出しなければ、翌月からの算定（売上計上）はできない
- システム挙動: ユーザーが「4月から加算を取りたい」と入力した場合、システムは「3月15日までに変更届の出力と提出が必要です」とアラートを出す
- 届出が完了するまで売上シミュレーションに反映させない

### AIアラート機能
- 職員の経験年数が「4年11ヶ月」から「5年」に変わるタイミングを予測
- 「来月15日までに変更届を出せば上位加算が取れる」旨をアラート
- 加算の届出期限が近づいた場合のリマインダー

---

## 履歴・時点管理の徹底（Time Travel）

### 要件
- 事業所マスタ、職員情報、加算情報はすべて**「有効期間（Valid From - Valid To）」**または**「変更履歴」**を持つこと
- 書類生成時は必ず `target_date` を引数に取り、その時点のスナップショット・データを参照して生成すること

### ユースケース
- 実地指導で「2年前の4月1日時点の人員配置」を問われた場合、即座にその時点のデータで勤務体制一覧表を出力
- 加算の取得開始日・終了日を正確に管理し、過去の請求内容を再現可能にする

---

## 書類自動生成システム

### 対象ファイルと生成戦略

#### 指定申請・届出書類群（Excel）
テンプレート: `templates/新規指定様式 R070401~_.xlsx`

3つの戦略を使い分ける：

**戦略A: マスタ注入（Master Injection）**
- 対象: 法人情報、事業所情報、管理者情報（固定的な基本情報）
- 処理: `基本情報入力シート` の特定セルにDBデータを直接書き込み
- 効果: 第1号様式（申請書）や別紙の定型部分がExcel関数で自動完成

**戦略B: 直接書き込み（Direct Write）**
- 対象: 勤務体制一覧表、経歴書（参考様式3）、実務経験証明書、設備・備品等一覧表
- 理由: 行数が可変（職員数や経歴数に依存）で複雑なレイアウト
- 処理: 該当シートを直接操作し、行の挿入・コピーを行いながらデータを流し込む

**戦略C: シートの動的選別（Dynamic Sheet Selection）**
- 処理: 事業形態と取得する加算に応じて不要なシートを削除
- 重要: 取得していない加算の加算届シートは提出禁止のため削除が必須

#### 運営記録書類群（Word）
対象: ヒヤリハット報告書、事故報告書、苦情受付記録等

**戦略: テンプレート置換（Template Substitution）**
- Word内の記入箇所を一意の置換タグ（`{{incident_date}}`, `{{user_name}}`等）に置換
- python-docx等のライブラリで実装

---

## サービス種別ごとの必須シート

### 共通必須
- 基本情報入力シート
- 第1号様式（申請書）
- 参考様式1（勤務体制一覧）※最重要
- 参考様式2（設備・備品）
- 参考様式3系（経歴書 - 該当職員分すべて）
- 参考様式6（苦情解決）
- 参考様式7（誓約書）
- 体制等状況一覧表
- 業務管理体制届出書（R07必須）
- メールアドレスの登録（R07必須）

### 児童発達支援の場合
- 付表2（児童発達支援）
- 報酬算定区分（児発）

### 放課後等デイサービスの場合
- 付表4（放課後等デイサービス）
- 報酬算定区分（放デイ）

### 多機能型の場合
- 付表7-1（多機能型総括表）

### 加算・減算関連
- additions リストに含まれる加算に対応するシートのみ出力
- R07: 支援プログラム未公表減算シートは、システム内で公表URLが未登録の場合自動出力

---

## 開発時の注意点

### Excel数式の保護
- `openpyxl` 等で書き込む際、テンプレートの計算式（VLOOKUP, IF等）を壊さない
- `data_only=False` モードで読み書きするか、値を入れるべきセルのみピンポイントで更新

### 改ページ・印刷範囲
- 行追加時に印刷範囲（Print Area）がずれる可能性
- 出力時に印刷範囲を再設定するか、余裕を持った行数を用意

### 和暦変換
- 行政書類は「令和〇年」形式が必須
- 西暦（YYYY-MM-DD）から和暦（GGEE年MM月DD日）への変換ユーティリティを実装

### ファイル名の管理
- 入力例ファイルは書き方の見本（仕様書）として参照
- 実装ベースには空のテンプレートを使用

---

## 監査対応に必要な帳票類（東京都）

### 必須帳票と記載ポイント

1. **個別支援計画書**: 支援の提供時間の記載が必須（令和6年度より）。「45分」等を明記し、実態と乖離していないこと
2. **サービス提供実績記録票**: 保護者の確認印、開始/終了時間を分単位で正確に記録
3. **サービス提供記録（ケース記録）**: 支援の内訳（直接/間接）を記録。相手方の反応も記述
4. **関係機関との連携記録**: 会議録、電話記録、メール等を保存（連携加算の算定根拠）
5. **勤務体制一覧表**: 常勤換算の計算根拠。監査で最も重点的にチェックされる書類

---

*最終更新: 2026-02-25*

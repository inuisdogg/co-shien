# 新規登録フロー動作確認ガイド

## テスト環境の準備

### 1. 環境変数の確認
以下の環境変数が設定されているか確認してください：

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Resend (メール送信)
RESEND_API_KEY=your_resend_api_key
RESEND_FROM_EMAIL=noreply@your-domain.com

# アプリケーションURL
NEXT_PUBLIC_APP_URL=https://roots.inu.co.jp/business
```

### 2. テスト用メールアドレスの準備
- テスト用のメールアドレスを2つ用意（Biz用とパーソナル用）
- メール受信が確認できる環境を用意

## テストシナリオ

### シナリオ1: Biz（事業所向け）新規登録フロー

#### ステップ1: メールアドレス入力
1. `https://roots.inu.co.jp/business/signup` にアクセス
2. テスト用メールアドレスを入力
3. 利用規約に同意
4. 「アカウントを作成」をクリック

**確認ポイント:**
- ✅ メールアドレスのバリデーションが機能しているか
- ✅ 重複チェックが機能しているか
- ✅ `/signup/waiting` ページにリダイレクトされるか

#### ステップ2: メール認証
1. 送信されたメールを確認
2. メール内の認証リンクをクリック

**確認ポイント:**
- ✅ 認証メールが届いているか
- ✅ 認証リンクが正しく動作するか
- ✅ `/setup` ページにリダイレクトされるか

#### ステップ3: 本登録（パスワード設定）
1. `/setup` ページで以下を入力：
   - 氏名
   - パスワード（6文字以上）
   - パスワード（確認）
2. 「本登録を完了してログイン」をクリック

**確認ポイント:**
- ✅ 施設IDが自動発行されているか
- ✅ パスワードのバリデーションが機能しているか
- ✅ 自動ログインが成功するか
- ✅ `/biz` ページにリダイレクトされるか

#### ステップ4: メール確認
1. メールボックスを確認

**確認ポイント:**
- ✅ **個人アカウント発行のお知らせ**メールが届いているか
  - 件名: "Roots 個人アカウント発行完了のお知らせ"
  - 内容: 個人アカウント発行完了の通知
- ✅ **施設IDを記したお知らせ**メールが届いているか
  - 件名: "Roots 施設ID発行のお知らせ"
  - 内容: 施設IDが記載されている
- ✅ 2通のメールが届いているか

---

### シナリオ2: パーソナル（スタッフ向け）新規登録フロー

#### ステップ1: メールアドレス入力
1. `https://roots.inu.co.jp/career/personal/signup` にアクセス
2. 以下を入力：
   - 氏名
   - メールアドレス
   - パスワード（6文字以上）
   - パスワード（確認）
3. 利用規約に同意
4. 「アカウントを作成」をクリック

**確認ポイント:**
- ✅ バリデーションが機能しているか
- ✅ `/personal/signup/waiting` ページにリダイレクトされるか

#### ステップ2: メール認証
1. 送信されたメールを確認
2. メール内の認証リンクをクリック

**確認ポイント:**
- ✅ 認証メールが届いているか
- ✅ 認証リンクが正しく動作するか
- ✅ `/personal/setup` ページにリダイレクトされるか

#### ステップ3: 本登録完了
1. `/personal/setup` ページで自動処理を待つ

**確認ポイント:**
- ✅ ウェルカムメールが送信されるか
- ✅ 自動的にログイン状態になるか
- ✅ `/staff-dashboard` ページにリダイレクトされるか

#### ステップ4: メール確認
1. メールボックスを確認

**確認ポイント:**
- ✅ **個人アカウント発行のお知らせ**メールが1通だけ届いているか
  - 件名: "Roots ご登録ありがとうございます" または "Roots 個人アカウント発行完了のお知らせ"
  - 内容: 個人アカウント発行完了の通知
- ✅ 施設IDメールは届いていないか

---

## トラブルシューティング

### メールが届かない場合
1. 迷惑メールフォルダを確認
2. Resendのダッシュボードで送信ログを確認
3. 環境変数 `RESEND_API_KEY` と `RESEND_FROM_EMAIL` を確認

### 認証リンクが機能しない場合
1. Supabaseの認証設定を確認
2. `emailRedirectTo` のURLが正しいか確認
3. ブラウザのコンソールでエラーを確認

### 自動ログインが失敗する場合
1. ブラウザのコンソールでエラーを確認
2. `localStorage` にユーザー情報が保存されているか確認
3. パスワードハッシュが正しく保存されているか確認

### リダイレクト先が間違っている場合
1. 各ページの `router.push()` のパスを確認
2. ミドルウェアの設定を確認

---

## チェックリスト

### Biz新規登録フロー
- [ ] メールアドレス入力画面が表示される
- [ ] メール認証メールが届く
- [ ] メール認証リンクが機能する
- [ ] 本登録画面（パスワード設定）が表示される
- [ ] 施設IDが自動発行される
- [ ] 本登録完了後、自動ログインが成功する
- [ ] `/biz` ページにリダイレクトされる
- [ ] 個人アカウント発行メールが届く
- [ ] 施設IDメールが届く
- [ ] 合計2通のメールが届く

### パーソナル新規登録フロー
- [ ] 新規登録画面が表示される
- [ ] メール認証メールが届く
- [ ] メール認証リンクが機能する
- [ ] セットアップ完了画面が表示される
- [ ] 自動的にログイン状態になる
- [ ] `/staff-dashboard` ページにリダイレクトされる
- [ ] 個人アカウント発行メールが1通だけ届く
- [ ] 施設IDメールは届かない

---

## デバッグ用のログ確認

### ブラウザのコンソール
開発者ツール（F12）のコンソールタブで以下を確認：
- エラーメッセージ
- ネットワークリクエストの成功/失敗
- `localStorage` の内容

### サーバーログ
Next.jsの開発サーバーまたは本番サーバーのログで以下を確認：
- APIエンドポイントの呼び出し
- メール送信APIの成功/失敗
- データベース操作のエラー

### 確認コマンド
```bash
# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build
npm start
```

---

## テスト用データのクリーンアップ

テスト完了後、以下のデータを削除することを推奨：

1. **Supabase Auth**
   - テスト用ユーザーアカウントを削除

2. **usersテーブル**
   - テスト用ユーザーレコードを削除

3. **facilitiesテーブル**
   - テスト用施設レコードを削除

4. **localStorage**
   - ブラウザの `localStorage` をクリア

---

## 注意事項

- テスト用メールアドレスは実際にアクセス可能なものを使用してください
- 本番環境でテストする場合は、テストデータが本番データに影響しないよう注意してください
- メール送信API（Resend）の送信制限に注意してください


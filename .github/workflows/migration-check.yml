name: Migration Check
on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check migration naming
        run: |
          for f in supabase/migrations/*.sql; do
            if [[ ! "$f" =~ ^supabase/migrations/[0-9]{14}_ ]]; then
              echo "Invalid migration name: $f"
              exit 1
            fi
          done
      - name: Check for USING(true) in new migrations
        run: |
          git diff --name-only origin/main...HEAD -- 'supabase/migrations/*.sql' | while read f; do
            if grep -i 'USING\s*(true)' "$f" 2>/dev/null; then
              echo "WARNING: Found USING(true) in $f - this may be a security concern"
            fi
          done

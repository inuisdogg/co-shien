# 機能設計書：行政提出書類・運営記録の自動生成システム

## プロジェクトの目的と背景
本機能は、障害児通所支援事業（放課後等デイサービス等）における指定申請書類および運営記録を、SaaSデータから自動生成するものである。

開発における最重要コンコンセプトは以下の2点である。
1.  **コンプライアンス（法令順守）の厳密な反映**: 加算の取得や減算の適用は、UI上のチェックボックス操作だけで即座に売上予測等に反映されてはならない。「行政への届出（毎月15日締切）→受理→翌月適用」という実務プロセスをシステムロジックとして実装すること。
2.  **完全な履歴管理（Time Travel）**: 行政監査に対応するため、「過去の特定日（例：2年前の4月1日）」における事業所の体制、職員配置、加算取得状況を完全に再現し、その時点のデータで書類を出力できること。

# 機能設計書：行政提出書類・運営記録の自動生成システム

## 0. 事前準備 (Setup)
**開発を開始する前に、以下のファイル操作を実行してください。**
1.  プロジェクトルートに `templates` フォルダを作成しました
2.  提供されたすべてのExcelファイル（`新規指定様式...xlsx`等）およびWordファイル（`.docx`, `.doc`）を、この `templates` フォルダ内に移動してあります
3.  以降の実装では、このフォルダ内のパスを参照してファイルを読み込んでください。

---

## 1. 概要 (Overview)
本ドキュメントは、障害児通所支援事業（放課後等デイサービス、児童発達支援等）における「指定申請書類（Excel）」および「日常業務の記録書類（Word）」を、SaaS内のデータから自動生成する機能の設計仕様である。

## 2. 扱うファイルと生成戦略 (Target Files & Strategy)

### 2.1 指定申請・届出書類群 (Excel)
**対象ファイル:** `templates/新規指定様式　R070401~_.xlsx` （最新版を使用）

このExcelファイルは、**「基本情報入力シート」**に入力されたデータが、関数によって各様式（申請書や付表）に自動転記される構造を持っている。SaaS側での処理は、Excelの特性に合わせて以下の3つの戦略を使い分ける。

* **戦略A：マスタ注入 (Master Injection)**
    * **対象:** 法人情報、事業所情報、管理者情報など（固定的な基本情報）
    * **処理:** `基本情報入力シート` の特定セル（例: `D12`, `H20`）に対し、SaaSのデータベースから値を直接書き込む。
    * **効果:** これにより、第1号様式（申請書）や別紙などの定型部分がExcelの関数によって自動完成される。
* **戦略B：直接書き込み (Direct Write)**
    * **対象:** `勤務体制一覧表`、`経歴書(参考様式3)`、`実務経験証明書`、`設備・備品等一覧表`
    * **理由:** これらは行数が可変（職員数や経歴数に依存）であり、複雑なレイアウトを持つため、基本情報シートからの転記だけでは完結しない。
    * **処理:** 該当するシート（例：`参考様式1`）を直接操作し、行の挿入・コピーを行いながらデータを流し込む。
* **戦略C：シートの動的選別 (Dynamic Sheet Selection)**
    * **処理:** ユーザーの事業形態（例：放課後等デイサービス単独、多機能型など）および「取得する加算」に応じて、**不要なシートを削除（または非表示）**にして出力する。
    * **重要:** 「加算届」に関するシートは、その加算を取得していない場合は提出してはならないため、削除が必須となる。

### 2.2 運営記録書類群 (Word)
**対象ファイル:** `templates/ヒヤリハット報告書.docx`, `templates/事故報告書.xls` (docx変換推奨), `templates/苦情受付記録.doc` 等

* **戦略：テンプレート置換 (Template Substitution)**
    * Wordファイル内の記入箇所（例: `令和　　年　　月　　日` や `氏名:__________`）を、一意の置換タグ（例: `{{incident_date}}`, `{{user_name}}`）と見なし、データを流し込む。
    * Pythonの `python-docx` 等のライブラリを用いて実装する。

---

## 3. データモデリング要件 (Data Architecture Requirements)

**※重要：具体的なテーブル名は既存のシステム設計（Claude Code構築分）に合わせてください。ただし、以下の「データが持つべき特性」は必ず実装に含めてください。**

### 3.1 「履歴・時点」管理の徹底 (Time-Series / Snapshot)
行政監査や変更届作成のため、「過去の特定日」の状態を再現する必要がある。
* **要件:** 事業所マスタ、職員情報、加算情報はすべて**「有効期間（Valid From - Valid To）」**または**「変更履歴」**を持つこと。
* **処理:** 書類生成時は必ず `target_date` を引数に取り、その時点のスナップショット・データを参照して生成すること。

### 3.2 加算ステータスのライフサイクル管理
加算は「チェック＝即売上」ではない。以下のステータス管理を実装すること。
* `Planned` (計画中: 売上予測には含めない)
* `Applying` (届出準備中: 書類出力可能。**前月15日**までに提出が必要)
* `Active` (適用中: 行政受理済み。売上に反映)
* `Inactive` (廃止/停止)

### 3.3 業務ルール：15日締切と売上連動
* **ルール:** 加算を新規取得・区分変更する場合、**「前月の15日まで」**に行政へ変更届を提出しなければ、翌月からの算定（売上計上）はできない。
* **システム挙動:** ユーザーが「4月から加算を取りたい」と入力した場合、システムは「3月15日までに変更届の出力と提出が必要です」とアラートを出し、届出が完了するまで売上シミュレーションに反映させないこと。

---

## 4. Excelシート出力定義 (Mapping Logic)

### 4.1 基本情報入力シートのマッピング (Main Mapping)
※セル番地は `新規指定様式 R07...` を解析して特定すること。以下はR06版に基づく目安である。

| 項目名 | データソース | Excelセル目安 | 備考 |
| :--- | :--- | :--- | :--- |
| 指定予定年月日 | `designation_date` | `H23` 付近 | 和暦変換が必要 (例: 令和7年4月1日) |
| 法人名 | `corporation_name` | `H40` 付近 | |
| 法人所在地 | `corporation_address` | `H32` 付近 | |
| 代表者名 | `representative_name` | `H42` 付近 | |
| 事業所名 | `office_name` | `H46` 付近 | |
| 事業所所在地 | `office_address` | `H53` 付近 | |
| サービス種別(児発) | `has_child_dev` | `H60` 付近 | 該当する場合 "○" |
| サービス種別(放デイ) | `has_after_school` | `H61` 付近 | 該当する場合 "○" |
| 管理者氏名 | `manager.name` | `H30` 付近 | |

### 4.2 サービス種別ごとの必須シート (Sheet Selector)
出力時に**残すべきシート**の定義。これ以外は削除する。

1.  **共通必須**
    * `基本情報入力シート`
    * `第1号様式` (申請書)
    * `付表7-1` (多機能型総括表 - 多機能型の場合のみ)
    * `参考様式1` (勤務体制一覧) ※最も重要
    * `参考様式2` (設備・備品)
    * `参考様式3`系 (経歴書 - 該当職員分すべて)
    * `参考様式6` (苦情解決)
    * `参考様式7` (誓約書)
    * `体制等状況一覧表`
    * `業務管理体制届出書` (R07必須)
    * `メールアドレスの登録` (R07必須)

2.  **児童発達支援 (Child Dev) の場合**
    * `付表2` (児童発達支援)
    * `報酬算定区分(児発)`

3.  **放課後等デイサービス (After School) の場合**
    * `付表4` (放課後等デイサービス)
    * `報酬算定区分(放デイ)`

4.  **加算・減算関連 (Dynamic)**
    * `additions` リストに含まれる加算に対応するシートのみを出力。
    * **重要 (R07):** `支援プログラム未公表減算` シートは、システム内で公表URLが未登録の場合、自動的に出力対象とする。

---

## 5. 開発時の注意点 (Development Notes)

1.  **エクセル数式の保護**
    * `openpyxl` 等で書き込む際、テンプレートにもともと入っている計算式（`=VLOOKUP(...)` や `=IF(...)`）を壊さないように、`data_only=False` モードで読み書きするか、**値を入れるべきセルのみ**をピンポイントで更新する実装にすること。
2.  **改ページ・印刷範囲**
    * 行を追加（職員数が増えた場合など）すると、印刷範囲（Print Area）がずれる可能性がある。出力時に印刷範囲を再設定するか、あらかじめ余裕を持った行数を用意しておくロジックを検討すること。
3.  **和暦変換**
    * 行政書類は「令和〇年」形式が必須であるため、西暦(YYYY-MM-DD)から和暦(GGEE年MM月DD日)への変換ユーティリティを実装すること。
4.  **ファイル名の管理**
    * 入力例ファイル（`...入力例）.xlsx`）はあくまで「書き方の見本（仕様書）」として参照し、システム実装のベースには空のテンプレートを使用するか、入力例データのセルをクリアしてから値を注入すること。